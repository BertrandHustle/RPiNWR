# -*- coding: utf-8 -*-
__author__ = 'ke4roh'

from RPiNWR.messages.NWSText import *
from RPiNWR.messages.NWSText import _split_ugc as split_ugc
import unittest
from shapely.geometry import Polygon


class TestNWSText(unittest.TestCase):
    def testSingle(self):
        plain_msg = """
SEVERE THUNDERSTORM WARNING
MEC001-005-015-023-232100-
/O.NEW.KGYX.SV.W.0082.160723T2016Z-160723T2100Z/

BULLETIN - IMMEDIATE BROADCAST REQUESTED
SEVERE THUNDERSTORM WARNING
NATIONAL WEATHER SERVICE GRAY ME
416 PM EDT SAT JUL 23 2016

THE NATIONAL WEATHER SERVICE IN GRAY MAINE HAS ISSUED A

* SEVERE THUNDERSTORM WARNING FOR...
  SOUTHEASTERN SAGADAHOC COUNTY IN SOUTH CENTRAL MAINE...
  SOUTHWESTERN LINCOLN COUNTY IN SOUTH CENTRAL MAINE...
  SOUTHEASTERN ANDROSCOGGIN COUNTY IN SOUTHWESTERN MAINE...
  EAST CENTRAL CUMBERLAND COUNTY IN SOUTHWESTERN MAINE...

* UNTIL 500 PM EDT

* AT 415 PM EDT...A SEVERE THUNDERSTORM WAS LOCATED NEAR
  FREEPORT...OR NEAR BRUNSWICK...MOVING SOUTHEAST AT 30 MPH.

  HAZARD...60 MPH WIND GUSTS AND QUARTER SIZE HAIL.

  SOURCE...RADAR INDICATED.

  IMPACT...HAIL DAMAGE TO VEHICLES IS EXPECTED. EXPECT WIND DAMAGE
           TO ROOFS...SIDING...AND TREES.

* LOCATIONS IMPACTED INCLUDE...
  BRUNSWICK...BATH...FREEPORT...GEORGETOWN...YARMOUTH...HARPSWELL...
  AROWSIC...PHIPPSBURG AND WEST BATH.

PRECAUTIONARY/PREPAREDNESS ACTIONS...

FOR YOUR PROTECTION MOVE TO AN INTERIOR ROOM ON THE LOWEST FLOOR OF A
BUILDING.

LARGE HAIL AND DAMAGING WINDS AND CONTINUOUS CLOUD TO GROUND
LIGHTNING IS OCCURRING WITH THIS STORM. MOVE INDOORS IMMEDIATELY.
LIGHTNING IS ONE OF NATURE`S LEADING KILLERS. REMEMBER...IF YOU CAN
HEAR THUNDER...YOU ARE CLOSE ENOUGH TO BE STRUCK BY LIGHTNING.

TORRENTIAL RAINFALL IS OCCURRING WITH THIS STORM...AND MAY LEAD TO
FLASH FLOODING. DO NOT DRIVE YOUR VEHICLE THROUGH FLOODED ROADWAYS.

&&

LAT...LON 4374 6970 4363 6981 4378 7015 4393 7010
      4385 6970
TIME...MOT...LOC 2015Z 299DEG 24KT 4384 7004

HAIL...1.00IN
WIND...60MPH

$$
EKSTER


        """
        msgs = NWSText.factory(plain_msg)
        self.assertEquals(1, len(msgs))
        msg = msgs[0]
        self.assertEquals(['MEC001', 'MEC005', 'MEC015', 'MEC023'], msg.ugc)
        self.assertEquals('/O.NEW.KGYX.SV.W.0082.160723T2016Z-160723T2100Z/', msg.vtec[0].raw)
        self.assertEquals(Polygon(((43.74, 69.70), (43.63, 69.81), (43.78, 70.15), (43.93, 70.10), (43.85, 69.70))),
                          msg.polygon)
        self.assertEquals(1469304960, msg.published)

    def test_ugc(self):
        ugcs, fips, ugcplaces = split_ugc('NDZ001>054-222115-')
        self.assertEquals('NDZ001', ugcs[0])
        self.assertEquals('NDZ054', ugcs[-1])
        self.assertEquals('NDZ002', ugcs[1])
        self.assertEquals('NDZ053', ugcs[-2])
        self.assertEquals(54, len(ugcs))
        self.assertIsNone(fips)
        self.assertEquals([], ugcplaces)

        ugcs, fips, ugcplaces = split_ugc('COZALL-220000-')
        self.assertEquals('COZALL', ugcs[0])
        self.assertEquals(1, len(ugcs))
        self.assertIsNone(fips)

        ugcs, fips, ugcplaces = split_ugc('AKZ000-191846-')
        self.assertEqual('AKZ000', ugcs[0])
        self.assertEquals(1, len(ugcs))
        self.assertIsNone(fips)

        ugcs, fips, ugcplaces = split_ugc(re.sub('\s*\n\s*', '', """ILC001-003-005-007-009-011-013-015-017-019-021-023-025-027-029-031-
033-035-037-039-041-043-045-047-049-051-053-055-057-059-061-063-065-
067-069-071-073-075-077-079-081-083-085-087-089-091-093-095-097-099-
101-103-105-107-109-111-113-115-117-119-121-123-125-127-129-131-133-
135-137-139-141-143-145-147-149-151-153-155-157-159-161-163-165-167-
169-171-173-175-177-179-181-183-185-187-189-191-193-195-197-199-201-
203-100215-"""))
        self.assertEqual('ILC001', ugcs[0])
        self.assertEqual('017001', fips[0])
        self.assertEqual(len(ugcs), len(fips))
        self.assertEqual(102, len(fips))
        self.assertEqual('017203', fips[-1])

        ugcs, fips, ugcplaces = split_ugc(
            'DCZ001-MDZ003>007-009>011-013-014-016>018-501-502-VAZ021-025>031-036>040-042-050>057-501-502-WVZ050>055-501>504-182200-')
        self.assertEqual('DCZ001', ugcs[0])
        self.assertEqual('MDZ003', ugcs[1])
        self.assertEqual('MDZ004', ugcs[2])
        self.assertEqual('WVZ504', ugcs[-1])
        self.assertIsNone(fips)

        ugcs, fips, ugcplaces = split_ugc("IAZ040>042-052>054-065>068-ILZ001-002-007-009-015>018-024-026-035-220430-" +
                                          "BUCHANAN-DELAWARE-DUBUQUE-LINN-JONES-JACKSON-CEDAR-CLINTON-" +
                                          "MUSCATINE-SCOTT-JO DAVIESS-STEPHENSON-CARROLL-WHITESIDE-" +
                                          "ROCK ISLAND-HENRY IL-BUREAU-PUTNAM-MERCER-WARREN-MCDONOUGH-")
        self.assertEquals("JO DAVIESS", ugcplaces[10])
        self.assertEquals("MCDONOUGH", ugcplaces[-1])

        def test_hwo(self):
            msgs = NWSText.factory("""855
FLUS42 KRAH 291958 AAA
HWORAH

HAZARDOUS WEATHER OUTLOOK...UPDATED
NATIONAL WEATHER SERVICE RALEIGH NC
358 PM EDT FRI JUL 29 2016

NCZ007>010-021>026-038>041-073>076-083-084-300000-
PERSON-GRANVILLE-VANCE-WARREN-FORSYTH-GUILFORD-ALAMANCE-ORANGE-
DURHAM-FRANKLIN-DAVIDSON-RANDOLPH-CHATHAM-WAKE-STANLY-MONTGOMERY-
MOORE-LEE-ANSON-RICHMOND-
358 PM EDT FRI JUL 29 2016

THIS HAZARDOUS WEATHER OUTLOOK IS FOR CENTRAL NORTH CAROLINA.

.DAY ONE...THIS AFTERNOON AND TONIGHT.

USE CAUTION WHILE OUTSIDE AGAIN TODAY AS HIGHS WILL AGAIN SURGE
WELL INTO THE 90S. HEAT INDICES SHOULD REACH 97 TO 102 DURING THE
AFTERNOON.

.DAYS TWO THROUGH SEVEN...SATURDAY THROUGH THURSDAY.

HAZARDOUS WEATHER IS NOT EXPECTED AT THIS TIME.

.SPOTTER INFORMATION STATEMENT...

SPOTTER ACTIVATION IS NOT EXPECTED AT THIS TIME.

$$

NCZ011-027-028-042-043-077-078-085-086-088-089-300000-
HALIFAX-NASH-EDGECOMBE-JOHNSTON-WILSON-HARNETT-WAYNE-SCOTLAND-HOKE-
CUMBERLAND-SAMPSON-
358 PM EDT FRI JUL 29 2016

...HEAT ADVISORY IN EFFECT UNTIL 8 PM EDT THIS EVENING...

THIS HAZARDOUS WEATHER OUTLOOK IS FOR CENTRAL NORTH CAROLINA.

.DAY ONE...THIS AFTERNOON AND TONIGHT.

PLEASE LISTEN TO NOAA WEATHER RADIO OR GO TO WEATHER.GOV ON THE
INTERNET FOR MORE INFORMATION ABOUT THE FOLLOWING HAZARDS.

   HEAT ADVISORY.

PLEASE LISTEN TO NOAA WEATHER RADIO OR GO TO WEATHER.GOV ON THE
INTERNET FOR MORE INFORMATION ABOUT THE FOLLOWING HAZARDS.

   HEAT ADVISORY.

.DAYS TWO THROUGH SEVEN...SATURDAY THROUGH THURSDAY.

HEAT ADVISORIES MAY BE NECESSARY AGAIN ON SATURDAY AS THE HOT
TEMPERATURES AND HIGH HUMIDITY CONTINUE.

.SPOTTER INFORMATION STATEMENT...

SPOTTER ACTIVATION IS NOT EXPECTED AT THIS TIME.

$$
""")
            self.assertEqual(
                ['NCZ007', 'NCZ008', 'NCZ009', 'NCZ010', 'NCZ021', 'NCZ022', 'NCZ023', 'NCZ024', 'NCZ025', 'NCZ026',
                 'NCZ038', 'NCZ039', 'NCZ040', 'NCZ041', 'NCZ073', 'NCZ074', 'NCZ075', 'NCZ076', 'NCZ083', 'NCZ084'],
                msgs[0].ugc)
            self.assertEqual(
                ['PERSON', 'GRANVILLE', 'VANCE', 'WARREN', 'FORSYTH', 'GUILFORD', 'ALAMANCE', 'ORANGE', 'DURHAM',
                 'FRANKLIN', 'DAVIDSON', 'RANDOLPH', 'CHATHAM', 'WAKE', 'STANLY', 'MONTGOMERY', 'MOORE', 'LEE', 'ANSON',
                 'RICHMOND'], msgs[0].ugc_places)
            self.assertEqual(
                ['NCZ011', 'NCZ027', 'NCZ028', 'NCZ042', 'NCZ043', 'NCZ077', 'NCZ078', 'NCZ085', 'NCZ086', 'NCZ088',
                 'NCZ089'],
                msgs[1].ugc)
            for i in range(0, 2):
                self.assertEqual(0, len(msgs[i].vtec))
                self.assertIsNone(msgs[i].FIPS6)
                self.assertIsNone(msgs[i].polygon)

    def test_cities_in_ugc_message(self):
        msgs = NWSText.factory("""
URGENT - WEATHER MESSAGE
NATIONAL WEATHER SERVICE QUAD CITIES IA IL
319 PM CDT THU JUL 21 2016

...DANGEROUS HEAT EXPECTED INTO SATURDAY...

.HOT AND HUMID CONDITIONS TO CONTINUE THROUGH SATURDAY. PEAK HEAT
INDICES NEAR 115 DEGREES WILL MAKE FOR OPPRESSIVE OUTDOOR
CONDITIONS AND AN ELEVATED RISK FOR HEAT EXHAUSTION AND HEAT
STROKE. OCCASIONAL SCATTERED THUNDERSTORMS ARE POSSIBLE TONIGHT
INTO SATURDAY...POSSIBLY PROVIDING A BRIEF PERIOD OF RELIEF FROM
THE EXCESSIVE HEAT FOR LOCALIZED AREAS.

IAZ040>042-052>054-065>068-ILZ001-002-007-009-015>018-024-026-035-
220430-
/O.CON.KDVN.EH.W.0001.000000T0000Z-160724T0000Z/
BUCHANAN-DELAWARE-DUBUQUE-LINN-JONES-JACKSON-CEDAR-CLINTON-
MUSCATINE-SCOTT-JO DAVIESS-STEPHENSON-CARROLL-WHITESIDE-
ROCK ISLAND-HENRY IL-BUREAU-PUTNAM-MERCER-WARREN-MCDONOUGH-
INCLUDING THE CITIES OF...INDEPENDENCE...MANCHESTER...DUBUQUE...
CEDAR RAPIDS...ANAMOSA...MAQUOKETA...TIPTON...CLINTON...
MUSCATINE...DAVENPORT...BETTENDORF...GALENA...FREEPORT...
MOUNT CARROLL...STERLING...MOLINE...ROCK ISLAND...GENESEO...
PRINCETON...HENNEPIN...ALEDO...MONMOUTH...MACOMB
319 PM CDT THU JUL 21 2016

...EXCESSIVE HEAT WARNING REMAINS IN EFFECT UNTIL 7 PM CDT
SATURDAY...

* HEAT INDEX VALUES...PEAKING BETWEEN 100 TO 115. LITTLE RELIEF
  IS EXPECTED AT NIGHT WITH HEAT INDICES ONLY DROPPING INTO THE
  75 TO 80 DEGREE RANGE.

* TIMING...OPPRESSIVE CONDITIONS WILL CONTINUE THROUGH SATURDAY
  EVENING.

* IMPACTS...THE PROLONGED PERIOD OF EXCESSIVE HEAT AND HUMIDITY
  WILL INCREASE THE RISK FOR HEAT EXHAUSTION OR HEAT STROKE.

PRECAUTIONARY/PREPAREDNESS ACTIONS...

AN EXCESSIVE HEAT WARNING MEANS THAT A PROLONGED PERIOD OF
DANGEROUSLY HOT TEMPERATURES AND HIGH HUMIDITY WILL OCCUR.  THIS
COMBINATION WILL LEAD TO A DANGEROUS SITUATION IN WHICH HEAT
ILLNESSES ARE LIKELY.  DRINK PLENTY OF FLUIDS... STAY IN AN AIR-
CONDITIONED ROOM... STAY OUT OF THE SUN... AND CHECK ON RELATIVES
AND NEIGHBORS... ESPECIALLY THE ELDERLY.

TAKE EXTRA PRECAUTIONS IF YOU WORK OR SPEND TIME OUTSIDE.  WHEN
POSSIBLE... RESCHEDULE STRENUOUS ACTIVITIES TO EARLY MORNING OR
EVENING.  KNOW THE SIGNS AND SYMPTOMS OF HEAT EXHAUSTION AND HEAT
STROKE.  WEAR LIGHT WEIGHT AND LOOSE FITTING CLOTHING WHEN
POSSIBLE AND DRINK PLENTY OF WATER.

TO REDUCE RISK DURING OUTDOOR WORK THE OCCUPATIONAL SAFETY AND
HEALTH ADMINISTRATION RECOMMENDS SCHEDULING FREQUENT REST BREAKS
IN SHADED OR AIR CONDITIONED ENVIRONMENTS.  ANYONE OVERCOME BY
HEAT SHOULD BE MOVED TO A COOL AND SHADED LOCATION.  HEAT STROKE
IS AN EMERGENCY... CALL 9 1 1.

&&

$$

        """)
        self.assertEqual(1, len(msgs))
        ugcplaces = msgs[0].ugc_places
        self.assertEquals("JO DAVIESS", ugcplaces[10])
        self.assertEquals("MCDONOUGH", ugcplaces[-1])